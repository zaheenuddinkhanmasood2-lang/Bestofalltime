name: Supabase Schema Sync

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'supabase/migrations/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Sync action to perform'
        required: true
        default: 'pull'
        type: choice
        options:
          - pull
          - push
          - both
      dry_run:
        description: 'Perform dry run only'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SUPABASE_VERSION: 'latest'

jobs:
  # Job 1: Pull schema changes from Supabase
  pull-schema:
    name: Pull Schema from Supabase
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.action == 'pull' || github.event.inputs.action == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Supabase CLI
        run: |
          npm install -g supabase@${{ env.SUPABASE_VERSION }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup Supabase
        run: |
          # Initialize Supabase if not already done
          if [ ! -f "supabase/config.toml" ]; then
            supabase init
          fi
          
          # Link to Supabase project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Pull Schema Changes
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          chmod +x scripts/sync_pull.sh
          ./scripts/sync_pull.sh

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git push origin ${{ github.ref_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: sync schema from Supabase $(date +%Y-%m-%d\ %H:%M:%S)"
          title: "Auto-sync: Schema changes from Supabase"
          body: |
            This PR contains automated schema changes pulled from Supabase.
            
            **Generated by:** GitHub Actions
            **Source:** Supabase database
            **Time:** $(date)
            
            Please review the changes before merging.
          branch: auto-sync/schema-$(date +%Y%m%d-%H%M%S)
          delete-branch: true

  # Job 2: Apply migrations to Supabase
  push-migrations:
    name: Apply Migrations to Supabase
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.action == 'push' || github.event.inputs.action == 'both'
    needs: pull-schema
    if: always() && (needs.pull-schema.result == 'success' || needs.pull-schema.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Supabase CLI
        run: |
          npm install -g supabase@${{ env.SUPABASE_VERSION }}

      - name: Setup Supabase
        run: |
          # Initialize Supabase if not already done
          if [ ! -f "supabase/config.toml" ]; then
            supabase init
          fi
          
          # Link to Supabase project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Dry Run - Test Migrations
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          chmod +x scripts/sync_push.sh
          ./scripts/sync_push.sh --dry-run

      - name: Apply Migrations
        if: github.event.inputs.dry_run != 'true'
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          ./scripts/sync_push.sh --force

      - name: Verify Migration Success
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          # Test database connection
          supabase status
          
          # Run basic verification queries
          echo "Verifying database connection..."
          # Add your verification queries here

  # Job 3: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 4: Notify on Failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [pull-schema, push-migrations]
    
    steps:
      - name: Notify Failure
        run: |
          echo "Schema sync failed. Check the logs for details."
          # Add your notification logic here (Slack, email, etc.)

  # Job 5: Cleanup
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    needs: [pull-schema, push-migrations]
    
    steps:
      - name: Cleanup old backups
        run: |
          # Clean up old backup files (older than 30 days)
          find . -name "backup_*.sql" -mtime +30 -delete 2>/dev/null || true
          
      - name: Cleanup old logs
        run: |
          # Clean up old log files (older than 7 days)
          find . -name "*.log" -mtime +7 -delete 2>/dev/null || true
